name: frontend-deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    strategy:
      matrix:
        include:
          - env: dev
          # TODO: Enable stg once Secrets/Variables are provisioned.
          # - env: stg
          # TODO: Enable prd after verifying dev/stg deployment pipeline.
          # - env: prd
    environment: ${{ matrix.env }}
    env:
      AWS_REGION: ${{ vars.AWS_REGION || 'ap-northeast-1' }}
      # VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
      # VITE_COGNITO_DOMAIN: ${{ vars.VITE_COGNITO_DOMAIN }}
      # VITE_COGNITO_CLIENT_ID: ${{ vars.VITE_COGNITO_CLIENT_ID }}
      # VITE_COGNITO_REDIRECT_URI: ${{ vars.VITE_COGNITO_REDIRECT_URI }}
      # VITE_COGNITO_LOGOUT_REDIRECT: ${{ vars.VITE_COGNITO_LOGOUT_REDIRECT }}
      # VITE_AWS_REGION: ${{ vars.VITE_AWS_REGION || vars.AWS_REGION || 'ap-northeast-1' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install & Build
        run: |
          npm ci
          npm run build

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload assets (immutable) — 1行
        run: |
          aws s3 cp dist/ s3://$FRONT_BUCKET/ --recursive --exclude "*.html" --cache-control "public,max-age=31536000,immutable"
        env:
          FRONT_BUCKET: ${{ secrets.FRONT_BUCKET }}

      - name: Upload HTML (short cache) — 1行
        run: |
          aws s3 cp dist/ s3://$FRONT_BUCKET/ --recursive --exclude "*" --include "*.html" --cache-control "public,max-age=60,must-revalidate"
        env:
          FRONT_BUCKET: ${{ secrets.FRONT_BUCKET }}

      - name: Invalidate minimal paths — 1行
        run: |
          aws cloudfront create-invalidation --distribution-id "$CF_ID" --paths "/index.html" "/"
        env:
          CF_ID: ${{ secrets.CF_DISTRIBUTION_ID }}
